#
# requires the following gitlab secret variables
#
# - NEXUS_USERNAME
# - NEXUS_PASSWORD
# - NEXUS_REPO_URL
#
# - GCPAPPENGINEREPO_USERNAME
# - GCPAPPENGINEREPO_PASSWORD
# - GCPAPPENGINEREPO_REPO_URL
#

image: maven:3.5.3-jdk-8

before_script:
  - export BASELINE=2.0.0
  - export REVISION=$BASELINE.$(date +%Y%m%d)-$(date +%H%M)-$(echo $CI_COMMIT_SHA | cut -c1-8)

stages:
  - build-package-push

build-package-push:
  stage: build-package-push
  script:
    - echo "REVISION=$REVISION"
    - echo "GCPAPPENGINEREPO_URL=$GCPAPPENGINEREPO_URL"
    - >
      mvn -s .m2/settings.xml \
          --batch-mode \
          clean deploy \
          -Dgcpappenginerepo-deploy \
          -Dgcpappenginerepo-deploy.repositoryUrl=$GCPAPPENGINEREPO_URL \
          -Drevision=$REVISION \
          $CORE_ADDITIONAL_OPTS
    - >
      mvn -s .m2/settings.xml \
          --batch-mode \
          clean deploy \
          -Drevision=$REVISION \
          -Dnexus-deploy \
          -Dnexus-deploy.repositoryUrl=$NEXUS_REPO_URL \
          $CORE_ADDITIONAL_OPTS
